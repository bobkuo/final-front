import{bc as R,bd as Y,a9 as G,bf as Z,r as c,w as ee,t as ae,z as C,m as f,B as s,f as o,az as le,ae as oe,ac as l,aw as j,q as S,u as E,l as L,p as $,ab as A,F as te,A as re,L as x,be as se,ay as ne,ad as P,aS as ie,c as J,Q as B}from"./index-ZlmJWsMw.js";import{c as H,Q as ue,a as k,b as de}from"./QTable-BHk4tmF_.js";import{Q as me}from"./QToolbar-CZadikzo.js";import{Q as K}from"./QImg-BneDaiVU.js";import{Q as ce}from"./QPage-kjWgpU47.js";import{p as O}from"./product-CyIB1ZbY.js";import{Q as pe}from"./QForm-CDCNFlVf.js";import{u as ge,c as ve,e as fe,a as N,f as be,b as Q}from"./index.esm-BOT0og31.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./QList-B6qOs73r.js";import"./rtl-DFPa-2ov.js";import"./QChip-7DxszJLz.js";import"./selection-DJuinEMp.js";import"./QItemLabel-B2FwfS6L.js";import"./QMenu-Dx5LITJC.js";import"./format-BvkBI9bc.js";import"./use-fullscreen-CXz7WVws.js";const we={class:"text-h6"},Ve={key:0,class:"row"},xe="products",he={__name:"ProductDialog",props:R({product:Object},{modelValue:{},modelModifiers:{}}),emits:R(["close"],["update:modelValue"]),setup(D,{emit:p}){const b=Y(D,"modelValue"),u=D,F=p,y=G(),h=Z("fileAgent"),M=["電子產品","服裝","家居用品","書籍","玩具","食品","其他"],{handleSubmit:T,resetForm:q,isSubmitting:d}=ge({validationSchema:ve({name:N().required("商品名稱是必填的").max(100,"商品名稱最多只能有 100 個字元"),price:be().typeError("價格是必填的").required("價格是必填的").min(0,"價格不能為負數"),category:N().required("分類是必填的").oneOf(M,"請選擇有效的分類"),description:N().max(500,"描述最多只能有 500 個字元"),sell:fe().required("是否上架是必填的")}),initialValues:{name:"",price:0,category:"",description:"",sell:!1}}),m=Q("name"),g=Q("price"),w=Q("category"),t=Q("description"),r=Q("sell"),e=c([]),_=c([]),V=c([]),U=c([]);ee(()=>u.product,i=>{i&&(m.value.value=i.name,g.value.value=i.price,w.value.value=i.category,t.value.value=i.description,r.value.value=i.sell,V.value=[...i.images],U.value=[])});const W=T(async i=>{if(e.value.some(a=>a.error)){y.notify({type:"negative",message:"請選擇有效的圖片檔案"});return}if(!u.product&&e.value.length===0){y.dialog({title:"錯誤",message:"請上傳商品圖片"});return}if(V.value.length+e?.value.length>5){y.dialog({title:"錯誤",message:`最多只能再上傳 ${5-V.value.length} 張圖片`});return}try{const a=new FormData;a.append("name",i.name),a.append("price",i.price),a.append("category",i.category),a.append("description",i.description),a.append("sell",i.sell),a.append("folder",xe),a.append("deletedImages",JSON.stringify(U.value)),e.value.length>0&&e.value.filter(v=>v.file).map(v=>v.file).forEach(v=>{a.append("images",v)});const{data:I}=await(u.product?O.update(u.product._id,a):O.create(a));y.notify({type:"positive",message:u.product?"商品更新成功":"商品新增成功"}),z(I.product)}catch(a){console.error(a),y.notify({type:"negative",message:a?.response?.data?.message||"操作失敗，請稍後再試"})}}),z=i=>{q(),h.value.deleteFileRecord(),e.value=[],_.value=[],F("close",i)},X=i=>{U.value.push(V.value[i]),V.value.splice(i,1)};return(i,a)=>{const I=ae("VueFileAgent");return f(),C(ie,{modelValue:b.value,"onUpdate:modelValue":a[8]||(a[8]=n=>b.value=n),persistent:""},{default:s(()=>[o(le,{class:"q-pa-md",style:{"min-width":"400px"}},{default:s(()=>[o(pe,{onSubmit:oe(l(W),["prevent"])},{default:s(()=>[o(j,null,{default:s(()=>[S("div",we,E(u.product?"編輯商品":"新增商品"),1)]),_:1}),o(j,{class:"q-gutter-md"},{default:s(()=>[o(A,{modelValue:l(m).value.value,"onUpdate:modelValue":a[0]||(a[0]=n=>l(m).value.value=n),deleteable:"",disable:l(d),error:!!l(m).errorMessage.value,"error-message":l(m).errorMessage.value,label:"名稱"},null,8,["modelValue","disable","error","error-message"]),o(A,{modelValue:l(g).value.value,"onUpdate:modelValue":a[1]||(a[1]=n=>l(g).value.value=n),disable:l(d),error:!!l(g).errorMessage.value,"error-message":l(g).errorMessage.value,label:"價格",type:"number",min:"0"},null,8,["modelValue","disable","error","error-message"]),o(H,{label:"分類",modelValue:l(w).value.value,"onUpdate:modelValue":a[2]||(a[2]=n=>l(w).value.value=n),disable:l(d),options:M,error:!!l(w).errorMessage.value,"error-message":l(w).errorMessage.value},null,8,["modelValue","disable","error","error-message"]),o(A,{modelValue:l(t).value.value,"onUpdate:modelValue":a[3]||(a[3]=n=>l(t).value.value=n),disable:l(d),error:!!l(t).errorMessage.value,"error-message":l(t).errorMessage.value,label:"描述",type:"textarea",outlined:""},null,8,["modelValue","disable","error","error-message"]),V.value.length>0?(f(),L("div",Ve,[(f(!0),L(te,null,re(V.value,(n,v)=>(f(),L("div",{key:v,class:"image-container",style:{position:"relative",width:"20%"}},[o(K,{src:n,style:{width:"100%"},alt:n},null,8,["src","alt"]),o(x,{round:"",dense:"",icon:"close",color:"negative",class:"delete-btn",size:"8px",onClick:ke=>X(v)},null,8,["onClick"])]))),128))])):$("",!0),o(I,{ref_key:"fileAgent",ref:h,modelValue:e.value,"onUpdate:modelValue":a[4]||(a[4]=n=>e.value=n),"raw-model-value":_.value,"onUpdate:rawModelValue":a[5]||(a[5]=n=>_.value=n),accept:"image/jpeg,image/png",deletable:"",disable:l(d),"error-text":{type:"檔案格式不正確",size:"檔案大小不得超過 1MB"},"help-text":"選擇或拖拽檔案",multiple:!0,maxFiles:5,"max-size":"5MB"},null,8,["modelValue","raw-model-value","disable"]),o(se,{label:l(r).value.value?"上架中":"未上架",modelValue:l(r).value.value,"onUpdate:modelValue":a[6]||(a[6]=n=>l(r).value.value=n),disable:l(d),error:!!l(r).errorMessage.value,"error-message":l(r).errorMessage.value},null,8,["label","modelValue","disable","error","error-message"]),o(ne,{align:"right"},{default:s(()=>[o(x,{color:"secondary",onClick:a[7]||(a[7]=n=>z())},{default:s(()=>a[9]||(a[9]=[P("取消",-1)])),_:1,__:[9]}),o(x,{type:"submit",loading:l(d),color:"primary"},{default:s(()=>[P(E(u.product?"更新":"新增"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue"])}}},_e=ye(he,[["__scopeId","data-v-beb5bbf7"]]),Qe={style:{"overflow-x":"auto","max-width":"100%"}},Ce={style:{display:"flex","align-items":"center",gap:"8px"}},Me={style:{width:"200px",height:"100px","overflow-y":"scroll","white-space":"pre-line"}},Pe={__name:"ProductsPage",setup(D){const p=c([]),b=c(""),u=c(null),F=J(()=>[...new Set(p.value.map(r=>r.category))].map(r=>({label:r,value:r}))),y=J(()=>p.value.filter(t=>{const r=!b.value||t.name.toLowerCase().includes(b.value.toLowerCase()),e=!u.value||t.category.toLowerCase().includes(u.value.toLowerCase());return r&&e})),h=G(),M=[{name:"action",label:"操作",field:"action"},{name:"images",label:"圖片",field:"images",align:"center",sortable:!1},{name:"name",label:"名稱",field:"name",sortable:!0},{name:"category",label:"分類",field:"category"},{name:"price",label:"價格",field:"price",align:"right",sortable:!0},{name:"description",label:"描述",field:"description"},{name:"sell",label:"上架",field:"sell"},{name:"createdAt",label:"建立日期",field:t=>new Date(t.createdAt).toLocaleString(),sortable:!0},{name:"updatedAt",label:"更新日期",field:t=>new Date(t.updatedAt).toLocaleString(),sortable:!0}];(async()=>{try{const{data:t}=await O.getAll();p.value=t.products}catch(t){console.error("Error fetching products:",t),h.notify({type:"negative",message:"無法載入商品資料"})}})();const q=t=>{h.dialog({title:"所有圖片",message:t.map(r=>`<img src="${r}" style="width: 100%; margin-bottom: 8px;" />`).join(""),html:!0})},d=c(!1),m=c(null),g=t=>{m.value=t,d.value=!0},w=t=>{if(t){const r=p.value.findIndex(e=>e._id===t._id);r!==-1?p.value[r]=t:p.value.push(t)}d.value=!1,m.value=null};return(t,r)=>(f(),C(ce,{class:"flex flex-center"},{default:s(()=>[S("div",Qe,[o(ue,{separator:"cell",rows:y.value,columns:M,"row-key":"id",class:"q-table--dense",pagination:{rowsPerPage:10}},{top:s(()=>[o(me,null,{default:s(()=>[o(x,{flat:"",icon:"add",label:"新增商品",onClick:r[0]||(r[0]=e=>g(null)),class:"q-mr-sm"}),o(de),o(A,{modelValue:b.value,"onUpdate:modelValue":r[1]||(r[1]=e=>b.value=e),dense:"",outlined:"",clearable:"",placeholder:"搜尋名稱"},{prepend:s(()=>[o(B,{name:"search"})]),_:1},8,["modelValue"]),o(H,{modelValue:u.value,"onUpdate:modelValue":r[2]||(r[2]=e=>u.value=e),dense:"",outlined:"",clearable:"",placeholder:"搜尋分類",options:F.value,"emit-value":"","map-options":""},{prepend:s(()=>[o(B,{name:"filter_list"})]),_:1},8,["modelValue","options"])]),_:1})]),"body-cell-images":s(e=>[o(k,{props:e},{default:s(()=>[S("div",Ce,[e.row.images&&e.row.images.length>0?(f(),C(K,{key:0,src:e.row.images[0],style:{width:"100px",height:"100px"},class:"q-ma-sm",alt:e.row.name},null,8,["src","alt"])):$("",!0),e.row.images.length>1?(f(),C(x,{key:1,outline:"",dense:"",label:"更多",onClick:_=>q(e.row.images)},null,8,["onClick"])):$("",!0)])]),_:2},1032,["props"])]),"body-cell-description":s(e=>[o(k,{props:e},{default:s(()=>[S("div",Me,E(e.row.description),1)]),_:2},1032,["props"])]),"body-cell-sell":s(e=>[o(k,{props:e},{default:s(()=>[e.row.sell?(f(),C(B,{key:0,name:"check",color:"green"})):$("",!0)]),_:2},1032,["props"])]),"body-cell-action":s(e=>[o(k,{props:e},{default:s(()=>[o(x,{flat:"",icon:"edit",onClick:_=>g(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows"])]),o(_e,{modelValue:d.value,"onUpdate:modelValue":r[3]||(r[3]=e=>d.value=e),product:m.value,onClose:w},null,8,["modelValue","product"])]),_:1}))}};export{Pe as default};
