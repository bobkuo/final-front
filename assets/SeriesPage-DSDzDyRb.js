import{bc as z,bd as K,a9 as E,r as v,w as I,z as A,m as u,B as a,f as l,az as X,aw as N,q as y,u as V,L as k,ad as h,l as S,F as O,A as P,R as ie,ag as ne,S as de,ay as Y,aS as Z,bf as ue,t as me,ae as ce,ac as i,p as M,ab as W,be as pe,c as ve,Q as G}from"./index-ZlmJWsMw.js";import{Q as ge,a as q,b as fe}from"./QTable-BHk4tmF_.js";import{Q as ye}from"./QToolbar-CZadikzo.js";import{Q as R}from"./QImg-BneDaiVU.js";import{Q as we}from"./QPage-kjWgpU47.js";import{s as j}from"./series-BHlUJG6Z.js";import{Q as ee,a as le,b as L}from"./QList-B6qOs73r.js";import{Q as ae}from"./QItemLabel-B2FwfS6L.js";import{Q as be}from"./QForm-CDCNFlVf.js";import{u as _e,c as xe,e as Ve,a as H,b as T}from"./index.esm-BOT0og31.js";import{w as ke}from"./work-BVkU3Fi2.js";import{_ as he}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./rtl-DFPa-2ov.js";import"./QChip-7DxszJLz.js";import"./selection-DJuinEMp.js";import"./QMenu-Dx5LITJC.js";import"./format-BvkBI9bc.js";import"./use-fullscreen-CXz7WVws.js";const Qe={class:"row justify-between items-center"},Ce={class:"text-caption text-grey-6"},De={__name:"WorklistDialog",props:z({works:Array,seriesId:String},{modelValue:{},modelModifiers:{}}),emits:z(["close"],["update:modelValue"]),setup($,{emit:_}){const p=K($,"modelValue"),m=$,Q=_,w=E(),C=v([]),c=v([]),D=s=>c.value.includes(s)?!1:c.value.length>=4,g=()=>{c.value=[]};I(c,s=>{s.length>4?(c.value=s.slice(0,4),w.notify({type:"warning",message:"最多只能選擇4張作品",timeout:2e3})):s.length===4&&w.notify({type:"positive",message:"已選擇4張作品",timeout:1500})});const f=async s=>{try{console.log("獲取指定系列的作品列表");const{data:e}=await ke.getList(s);C.value=e.works}catch(e){console.error("Error fetching works:",e),w.notify({type:"negative",message:"無法載入作品簡單列表"})}};I(p,s=>{s&&(m.works?(f(m.seriesId),c.value=m.works.map(e=>e._id)):(f(null),c.value=[]))});const x=()=>{Q("close")},o=()=>{const s=C.value.filter(e=>c.value.includes(e._id));Q("close",s)};return(s,e)=>(u(),A(Z,{modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=d=>p.value=d),persistent:""},{default:a(()=>[l(X,{class:"q-pa-md",style:{"min-width":"400px"}},{default:a(()=>[l(N,null,{default:a(()=>[y("div",Qe,[y("div",null,[e[2]||(e[2]=y("div",{class:"text-h6"},"選擇代表作品",-1)),y("div",Ce,"已選擇 "+V(c.value.length)+"/4 張作品",1)]),l(k,{outline:"",dense:"",color:"negative",onClick:g,disable:c.value.length===0},{default:a(()=>e[3]||(e[3]=[h(" 全部清除 ",-1)])),_:1,__:[3]},8,["disable"])])]),_:1}),l(N,{class:"q-gutter-md"},{default:a(()=>[l(ee,{bordered:"",separator:""},{default:a(()=>[(u(!0),S(O,null,P(C.value,d=>ie((u(),A(le,{key:d._id,tag:"label"},{default:a(()=>[l(L,{class:"q-ml-none"},{default:a(()=>[l(R,{src:d.images[0]},null,8,["src"])]),_:2},1024),l(L,null,{default:a(()=>[l(ae,null,{default:a(()=>[h(V(d.name),1)]),_:2},1024)]),_:2},1024),l(L,{avatar:""},{default:a(()=>[l(ne,{modelValue:c.value,"onUpdate:modelValue":e[0]||(e[0]=b=>c.value=b),val:d._id,disable:D(d._id)},null,8,["modelValue","val","disable"])]),_:2},1024)]),_:2},1024)),[[de]])),128))]),_:1})]),_:1}),l(Y,{align:"right"},{default:a(()=>[l(k,{color:"secondary",onClick:x},{default:a(()=>e[4]||(e[4]=[h("取消",-1)])),_:1,__:[4]}),l(k,{color:"primary",onClick:o},{default:a(()=>e[5]||(e[5]=[h("確定",-1)])),_:1,__:[5]})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Se={class:"text-h6"},Ae={class:"row items-center"},qe=["src"],Me={key:1,class:"image-container",style:{position:"relative",width:"100%"}},$e="series",Le={__name:"SeriesDialog",props:z({series:Object},{modelValue:{},modelModifiers:{}}),emits:z(["close"],["update:modelValue"]),setup($,{emit:_}){const p=K($,"modelValue"),m=$,Q=_,w=E(),C=ue("fileAgent"),{handleSubmit:c,resetForm:D,isSubmitting:g}=_e({validationSchema:xe({name:H().required("系列名稱是必填的").max(10,"作品標題最多只能有 10 個字元"),description:H().max(100,"描述最多只能有 100 個字元"),post:Ve().required("是否上首頁是必填的")}),initialValues:{name:"",description:"",post:!1}}),f=T("name"),x=T("description"),o=T("post"),s=v([]),e=v([]),d=v([]),b=v(""),U=v("");I(p,n=>{n&&!m.work&&(s.value=[],b.value="",U.value="")}),I(()=>m.series,n=>{n&&(f.value.value=n.name,x.value.value=n.description,o.value.value=n.post,s.value=n.works,b.value=n.cover,U.value="")});const te=c(async n=>{if(e.value[0]?.error){w.notify({type:"negative",message:"請選擇有效的圖片檔案"});return}if(b.value&&e.value.length>0){w.dialog({title:"錯誤",message:"請先刪除原來的封面圖片，才能上傳新圖片"});return}try{const t=new FormData;t.append("name",n.name),t.append("works",JSON.stringify(s.value.map(r=>r._id))),t.append("description",n.description),t.append("post",n.post),t.append("folder",$e),t.append("deletedImage",U.value),e.value.length>0&&t.append("image",e.value[0].file);const{data:B}=await(m.series?j.update(m.series._id,t):j.create(t));console.log("=== createOrUpdateSeries ===",B),w.notify({type:"positive",message:m.series?"系列更新成功":"系列新增成功"}),J(B.series)}catch(t){console.error(t),w.notify({type:"negative",message:t?.response?.data?.message||"操作失敗，請稍後再試"})}}),J=n=>{D(),C.value.deleteFileRecord(),e.value=[],d.value=[],Q("close",n)},se=()=>{U.value=b.value,b.value=""},F=v(!1),oe=()=>{F.value=!0},re=n=>{F.value=!1,n&&(s.value=n)};return(n,t)=>{const B=me("VueFileAgent");return u(),A(Z,{modelValue:p.value,"onUpdate:modelValue":t[7]||(t[7]=r=>p.value=r),persistent:""},{default:a(()=>[l(X,{class:"q-pa-md",style:{"min-width":"400px"}},{default:a(()=>[l(be,{onSubmit:ce(i(te),["prevent"])},{default:a(()=>[l(N,null,{default:a(()=>[y("div",Se,V(m.series?"編輯系列":"新增系列"),1)]),_:1}),l(N,{class:"q-gutter-md"},{default:a(()=>[l(W,{modelValue:i(f).value.value,"onUpdate:modelValue":t[0]||(t[0]=r=>i(f).value.value=r),deleteable:"",disable:i(g),error:!!i(f).errorMessage.value,"error-message":i(f).errorMessage.value,label:"系列名稱",maxlength:"10",counter:""},null,8,["modelValue","disable","error","error-message"]),y("div",Ae,[t[8]||(t[8]=y("div",{class:"text-overline text-grey-7 q-mr-xs"},"代表作品",-1)),m.series?(u(),A(k,{key:0,outline:"",color:"grey",icon:"add",dense:"",size:"sm",onClick:oe,disable:i(g)},null,8,["disable"])):M("",!0)]),s.value.length>0?(u(),A(ee,{key:0,bordered:"",separator:""},{default:a(()=>[(u(!0),S(O,null,P(s.value,r=>(u(),A(le,{key:r._id},{default:a(()=>[l(L,{thumbnail:"",class:"q-mr-xs text-center"},{default:a(()=>[y("img",{src:r.images[0],style:{"object-fit":"contain"}},null,8,qe)]),_:2},1024),l(L,null,{default:a(()=>[l(ae,null,{default:a(()=>[h(V(r.name),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):M("",!0),l(W,{modelValue:i(x).value.value,"onUpdate:modelValue":t[1]||(t[1]=r=>i(x).value.value=r),disable:i(g),error:!!i(x).errorMessage.value,"error-message":i(x).errorMessage.value,label:"描述",type:"textarea",outlined:"",maxlength:"100",counter:""},null,8,["modelValue","disable","error","error-message"]),t[10]||(t[10]=y("div",{class:"text-overline text-grey-7"},"系列封面",-1)),b.value?(u(),S("div",Me,[l(R,{src:b.value,style:{width:"100%"},alt:b.value},null,8,["src","alt"]),l(k,{round:"",dense:"",icon:"close",color:"negative",class:"delete-btn",size:"8px",onClick:se})])):M("",!0),l(B,{ref_key:"fileAgent",ref:C,modelValue:e.value,"onUpdate:modelValue":t[2]||(t[2]=r=>e.value=r),"raw-model-value":d.value,"onUpdate:rawModelValue":t[3]||(t[3]=r=>d.value=r),accept:"image/jpeg,image/png",deletable:"",disable:i(g),"error-text":{type:"檔案格式不正確",size:"檔案大小不得超過 5MB"},"help-text":"選擇或拖拽檔案","max-size":"5MB"},null,8,["modelValue","raw-model-value","disable"]),l(pe,{label:i(o).value.value?"已上首頁":"上首頁",modelValue:i(o).value.value,"onUpdate:modelValue":t[4]||(t[4]=r=>i(o).value.value=r),disable:i(g),error:!!i(o).errorMessage.value,"error-message":i(o).errorMessage.value},null,8,["label","modelValue","disable","error","error-message"]),l(Y,{align:"right"},{default:a(()=>[l(k,{color:"secondary",onClick:t[5]||(t[5]=r=>J(!1))},{default:a(()=>t[9]||(t[9]=[h("取消",-1)])),_:1,__:[9]}),l(k,{type:"submit",loading:i(g),color:"primary"},{default:a(()=>[h(V(m.series?"更新":"新增"),1)]),_:1},8,["loading"])]),_:1})]),_:1,__:[10]})]),_:1},8,["onSubmit"])]),_:1}),l(De,{modelValue:F.value,"onUpdate:modelValue":t[6]||(t[6]=r=>F.value=r),works:s.value,"series-id":m.series?._id,onClose:re},null,8,["modelValue","works","series-id"])]),_:1},8,["modelValue"])}}},Ie=he(Le,[["__scopeId","data-v-d6a883eb"]]),Ue={style:{"overflow-x":"auto","max-width":"100%"}},Fe={key:0,style:{display:"flex","align-items":"center",gap:"8px"}},Be={key:0,class:"row q-gutter-sm wrap"},ze={class:"text-overline text-center",style:{"overflow-y":"auto","white-space":"pre-line"}},Ne={key:0,style:{"overflow-y":"auto","white-space":"pre-line"}},sl={__name:"SeriesPage",setup($){const _=v([]),p=v(""),m=ve(()=>_.value.filter(o=>!p.value||o.name.toLowerCase().includes(p.value.toLowerCase()))),Q=v({page:1,rowsPerPage:5});I(p,()=>{Q.value.page=1});const w=E(),C=[{name:"action",label:"操作",field:"action",align:"center",style:"width: 3%"},{name:"post",label:"上首頁",field:"post",align:"center",style:"width: 2%"},{name:"name",label:"名稱",field:"name",align:"center",sortable:!0,style:"width: 5%"},{name:"cover",label:"封面",field:"cover",align:"center",sortable:!1,style:"width: 40%"},{name:"works",label:"代表作品",field:o=>o.works.join(", "),align:"left",style:"width: 20%"},{name:"description",label:"描述",field:"description",align:"left",style:"width: 20%"},{name:"createdAt",label:"建立日期",field:o=>new Date(o.createdAt).toLocaleString(),sortable:!0,style:"width: 5%"},{name:"updatedAt",label:"更新日期",field:o=>new Date(o.updatedAt).toLocaleString(),sortable:!0,style:"width: 5%"}];(async()=>{try{console.log("獲取系列列表");const{data:o}=await j.getAll();_.value=o.series}catch(o){console.error("Error fetching series:",o),w.notify({type:"negative",message:"無法載入系列資料"})}})();const D=v(!1),g=v(null),f=o=>{g.value=o,D.value=!0},x=o=>{if(o){const s=_.value.findIndex(e=>e._id===o._id);s!==-1?_.value[s]=o:_.value.push(o)}D.value=!1,g.value=null};return(o,s)=>(u(),A(we,{class:"flex flex-center"},{default:a(()=>[y("div",Ue,[l(ge,{separator:"cell",rows:m.value,columns:C,"row-key":"id",class:"q-table--dense q-mx-lg",pagination:Q.value,"onUpdate:pagination":s[2]||(s[2]=e=>Q.value=e),style:{width:"95vw",height:"90vh"}},{top:a(()=>[l(ye,null,{default:a(()=>[l(k,{flat:"",icon:"add",label:"新增系列",onClick:s[0]||(s[0]=e=>f(null)),class:"q-mr-sm"}),l(fe),l(W,{modelValue:p.value,"onUpdate:modelValue":s[1]||(s[1]=e=>p.value=e),dense:"",outlined:"",clearable:"",placeholder:"搜尋名稱"},{prepend:a(()=>[l(G,{name:"search"})]),_:1},8,["modelValue"])]),_:1})]),"body-cell-action":a(e=>[l(q,{props:e},{default:a(()=>[l(k,{flat:"",icon:"edit",onClick:d=>f(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"body-cell-post":a(e=>[l(q,{props:e},{default:a(()=>[e.row.post?(u(),A(G,{key:0,name:"check",size:"xs",color:"green"})):M("",!0)]),_:2},1032,["props"])]),"body-cell-cover":a(e=>[l(q,{props:e},{default:a(()=>[e.row.cover?(u(),S("div",Fe,[l(R,{src:e.row.cover,style:{width:"100%",height:"100%"},class:"q-ma-sm",alt:e.row.name,fit:"contain"},null,8,["src","alt"])])):M("",!0)]),_:2},1032,["props"])]),"body-cell-works":a(e=>[l(q,{props:e},{default:a(()=>[e.row.works.length>0?(u(),S("div",Be,[(u(!0),S(O,null,P(e.row.works,d=>(u(),S("div",{key:d._id,style:{width:"45%"}},[l(R,{src:d.images[0],alt:d.name,fit:"contain",style:{border:"1px solid gray"}},null,8,["src","alt"]),y("div",ze,V(d.name),1)]))),128))])):M("",!0)]),_:2},1032,["props"])]),"body-cell-description":a(e=>[l(q,{props:e},{default:a(()=>[e.row.description?(u(),S("div",Ne,V(e.row.description),1)):M("",!0)]),_:2},1032,["props"])]),"body-cell-createdAt":a(e=>[l(q,{props:e,style:{"white-space":"normal"}},{default:a(()=>[h(V(new Date(e.row.createdAt).toLocaleString()),1)]),_:2},1032,["props"])]),"body-cell-updatedAt":a(e=>[l(q,{props:e,style:{"white-space":"normal"}},{default:a(()=>[h(V(new Date(e.row.updatedAt).toLocaleString()),1)]),_:2},1032,["props"])]),_:1},8,["rows","pagination"])]),l(Ie,{modelValue:D.value,"onUpdate:modelValue":s[3]||(s[3]=e=>D.value=e),series:g.value,onClose:x},null,8,["modelValue","series"])]),_:1}))}};export{sl as default};
