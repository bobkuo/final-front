import{b9 as j,ba as K,bb as se,a3 as W,r as v,w as J,z as C,m as p,B as a,f as l,ax as ne,au as I,q as b,a5 as O,v as ae,a7 as k,Q as R,l as $,F as G,A as ee,u as A,bc as re,aw as ie,a8 as T,aP as ue,bd as ye,t as be,a9 as we,a6 as d,p as E,be as Ve,c as ke}from"./index-Drry56Kt.js";import{c as de,Q as _e,a as N,b as xe}from"./QTable-C-xxKEe8.js";import{Q as he}from"./QToolbar-DMIlA9pH.js";import{Q as me}from"./QImg-DYne1dE3.js";import{Q as te}from"./QBadge-DBHHBJmW.js";import{Q as Qe}from"./QPage-BIO45nO8.js";import{w as Z}from"./work-DMrj1F5f.js";import{s as Ce}from"./series-LHslhfhp.js";import{Q as $e}from"./QForm-CpnloYhQ.js";import{u as Ae,c as qe,e as Se,a as Y,b as P}from"./index.esm-9EgYtYs2.js";import{Q as De,a as Me,b as oe}from"./QList-MvZXWXt7.js";import{_ as Ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./rtl-DFPa-2ov.js";import"./QChip-JUS-V2ru.js";import"./QItemLabel-BO0NXGvT.js";import"./QMenu-BvQSTB46.js";import"./position-engine-Bw7ND2VZ.js";import"./selection-Biq6ja7B.js";import"./format-BvkBI9bc.js";import"./use-fullscreen-C-cdd5Wb.js";const ce={create(w){return j.apiAuth.post("/tag/add",w)},getAll(){return j.apiAuth.get("/tag/all")},update(w){return j.apiAuth.post("/tag/update",w)},delete(w){return j.apiAuth.post("/tag/delete",{name:w})}},Ne={key:0,class:"row"},Te={class:"row q-gutter-sm"},Fe={__name:"TagDialog",props:K({tags:Array},{modelValue:{},modelModifiers:{}}),emits:K(["close"],["update:modelValue"]),setup(w,{emit:M}){const f=se(w,"modelValue"),c=w,q=M,V=W(),y=v(""),g=v([]);J(f,n=>{n&&(console.log("Tag 對話框已開啟，執行初始化邏輯"),g.value=c.tags.map(o=>({label:o.name,value:o._id,enable:o.enable,isEditing:!1,newName:o.name})),console.log("初始化標籤選項:",g.value))},{immediate:!0});const D=()=>{if(!y.value.trim()){V.notify({type:"negative",message:"標籤名稱不能為空"});return}if(g.value.some(n=>n.label===y.value.trim())){V.notify({type:"negative",message:"標籤已存在"});return}g.value.push({label:y.value.trim(),value:y.value.trim(),enable:!0}),y.value=""},h=n=>{if(n<0||n>=g.value.length){console.error("無效的標籤索引:",n);return}g.value.splice(n,1)},_=n=>{if(!n.newName.trim()){n.isEditing=!1;return}if(g.value.some(o=>o.label===n.newName.trim()&&o.value!==n.value)){V.notify({type:"negative",message:"標籤已存在"});return}if(n.newName.trim()===n.label){n.isEditing=!1;return}n.label=n.newName.trim(),n.isEditing=!1},Q=async n=>{if(n)try{const o=g.value.map(i=>({_id:i.value,name:i.label,type:"插畫作品",enable:i.enable}));console.log("提交標籤更新:",o),await ce.update(o),V.notify({type:"positive",message:"標籤更新成功"})}catch(o){console.error("更新標籤時發生錯誤: ",o),V.notify({type:"negative",message:"無法更新標籤"})}y.value="",q("close")};return(n,o)=>(p(),C(ue,{modelValue:f.value,"onUpdate:modelValue":o[3]||(o[3]=i=>f.value=i),persistent:""},{default:a(()=>[l(ne,{class:"q-pa-md",style:{"min-width":"400px"}},{default:a(()=>[l(I,null,{default:a(()=>o[4]||(o[4]=[b("div",{class:"text-h6"},"管理標籤",-1)])),_:1,__:[4]}),l(I,null,{default:a(()=>[l(O,{"bottom-slots":"",modelValue:y.value,"onUpdate:modelValue":o[0]||(o[0]=i=>y.value=i),label:"新增標籤",clearable:"",counter:"",outlined:"",maxlength:"10",onKeyup:ae(D,["enter"])},{before:a(()=>[l(R,{name:"label"})]),hint:a(()=>o[5]||(o[5]=[])),append:a(()=>[l(k,{round:"",dense:"",flat:"",icon:"add",onClick:D})]),_:1},8,["modelValue"])]),_:1}),l(I,null,{default:a(()=>[l(De,null,{default:a(()=>[(p(!0),$(G,null,ee(g.value,(i,U)=>(p(),C(Me,{key:i.value},{default:a(()=>[l(oe,null,{default:a(()=>[i.isEditing?(p(),C(O,{key:1,modelValue:i.newName,"onUpdate:modelValue":s=>i.newName=s,dense:"",outlined:"",autofocus:"",onBlur:s=>_(i),onKeyup:ae(s=>_(i),["enter"])},null,8,["modelValue","onUpdate:modelValue","onBlur","onKeyup"])):(p(),$("div",Ne,[l(k,{size:"sm",dense:"",flat:"",icon:"edit",onClick:s=>i.isEditing=!0,class:"q-mr-sm"},null,8,["onClick"]),b("span",null,A(i.label),1)]))]),_:2},1024),l(oe,{side:""},{default:a(()=>[b("div",Te,[l(re,{dense:"",class:"q-pa-sm",style:{border:"1px solid #ccc"},modelValue:i.enable,"onUpdate:modelValue":s=>i.enable=s,label:"啟用"},null,8,["modelValue","onUpdate:modelValue"]),l(k,{size:"sm",outline:"",dense:"",icon:"delete",onClick:s=>h(U)},null,8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),l(ie,{align:"right"},{default:a(()=>[l(k,{color:"secondary",onClick:o[1]||(o[1]=i=>Q(!1))},{default:a(()=>o[6]||(o[6]=[T("取消",-1)])),_:1,__:[6]}),l(k,{color:"primary",onClick:o[2]||(o[2]=i=>Q(!0))},{default:a(()=>o[7]||(o[7]=[T("儲存",-1)])),_:1,__:[7]})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Be={class:"text-h6"},Ee={style:{border:"1px solid #aaa","border-radius":"4px",padding:"8px"}},Ie={class:"row justify-between"},Oe={key:0,class:"q-mr-xs"},ze={key:1,style:{"text-decoration":"line-through"},class:"text-grey-5 q-mr-xs"},Le={key:0,class:"row"},je="works",Pe={__name:"WorkDialog",props:K({work:Object,seriesOptions:Array},{modelValue:{},modelModifiers:{}}),emits:K(["close"],["update:modelValue"]),setup(w,{emit:M}){const f=se(w,"modelValue"),c=w,q=M,V=W(),y=ye("fileAgent"),{handleSubmit:g,resetForm:D,isSubmitting:h}=Ae({validationSchema:qe({name:Y().required("作品標題是必填的").max(100,"作品標題最多只能有 100 個字元"),category:Y().required("分類是必填的").test("is-valid-category","請選擇有效的分類",function(r){return c.seriesOptions.some(e=>e.value===r)}),content:Y().max(500,"內容最多只能有 500 個字元"),post:Se().required("是否張貼是必填的")}),initialValues:{name:"",category:"",content:"",post:!1}}),_=P("name"),Q=P("category"),n=P("content"),o=P("post"),i=v([]),U=v({views:0,likes:[]}),s=v([]),m=v([]),t=v([]),x=v([]),H=v([]),z=v([]),F=v([]);J(f,r=>{r&&!c.work&&(i.value=[],U.value={views:0,likes:[]},t.value=[],x.value=[],X())}),J(()=>c.work,r=>{r&&(_.value.value=r.name,Q.value.value=r.category._id,i.value=r.tags,n.value.value=r.content,o.value.value=r.post,U.value.value=r.statistics,t.value=[...r.images],x.value=[],X())});const pe=g(async r=>{if(s.value.some(e=>e.error)){V.notify({type:"negative",message:"請選擇有效的圖片檔案"});return}if(!c.work&&s.value.length===0){V.dialog({title:"錯誤",message:"請上傳作品圖片"});return}if(c.work?.images.length+s?.value.length>5){V.dialog({title:"錯誤",message:`最多只能再上傳 ${5-c.work.images.length} 張圖片`});return}try{const e=new FormData;e.append("name",r.name),e.append("category",r.category),e.append("tags",JSON.stringify(F.value)),e.append("content",r.content),e.append("post",r.post),e.append("folder",je),e.append("deletedImages",JSON.stringify(x.value)),s.value.length>0&&s.value.filter(S=>S.file).map(S=>S.file).forEach(S=>{e.append("images",S)});const{data:B}=await(c.work?Z.update(c.work._id,e):Z.create(e));V.notify({type:"positive",message:c.work?"作品更新成功":"作品新增成功"}),le(B.work)}catch(e){console.error(e),V.notify({type:"negative",message:e?.response?.data?.message||"操作失敗，請稍後再試"})}}),le=r=>{D(),y.value.deleteFileRecord(),s.value=[],m.value=[],q("close",r)},ve=r=>{x.value.push(t.value[r]),t.value.splice(r,1)},X=async()=>{F.value=[],z.value=[],H.value=[];try{const{data:r}=await ce.getAll();H.value=r.tags,console.log("獲取標籤列表"),z.value=r.tags.map(e=>({value:e._id,label:e.name,enable:e.enable,color:e.enable?"primary":"grey"})),F.value=z.value.filter(e=>i.value.some(B=>B._id===e.value)).map(e=>e.value)}catch(r){console.error("獲取標籤失敗",r)}},L=v(!1),ge=()=>{L.value=!0},fe=()=>{L.value=!1,console.log("重新獲取標籤列表"),X()};return(r,e)=>{const B=be("VueFileAgent");return p(),C(ue,{modelValue:f.value,"onUpdate:modelValue":e[9]||(e[9]=u=>f.value=u),persistent:""},{default:a(()=>[l(ne,{class:"q-pa-md",style:{"min-width":"400px"}},{default:a(()=>[l($e,{onSubmit:we(d(pe),["prevent"])},{default:a(()=>[l(I,null,{default:a(()=>[b("div",Be,A(c.work?"編輯作品":"新增作品"),1)]),_:1}),l(I,{class:"q-gutter-md"},{default:a(()=>[l(O,{modelValue:d(_).value.value,"onUpdate:modelValue":e[0]||(e[0]=u=>d(_).value.value=u),deleteable:"",disable:d(h),error:!!d(_).errorMessage.value,"error-message":d(_).errorMessage.value,label:"標題"},null,8,["modelValue","disable","error","error-message"]),l(de,{label:"分類",modelValue:d(Q).value.value,"onUpdate:modelValue":e[1]||(e[1]=u=>d(Q).value.value=u),disable:d(h),options:c.seriesOptions,"option-value":"value","option-label":"label","emit-value":"","map-options":"",error:!!d(Q).errorMessage.value,"error-message":d(Q).errorMessage.value},null,8,["modelValue","disable","options","error","error-message"]),b("div",Ee,[b("div",Ie,[e[10]||(e[10]=b("div",{class:"text-subtitle1 text-grey-7"},"標籤",-1)),l(k,{class:"q-mb-xs",color:"primary",size:"sm",dense:"",outline:"",icon:"edit",onClick:ge})]),l(Ve,{options:z.value,type:"checkbox",modelValue:F.value,"onUpdate:modelValue":e[2]||(e[2]=u=>F.value=u),inline:"",dense:""},{label:a(u=>[u.enable?(p(),$("span",Oe,A(u.label),1)):(p(),$("span",ze,A(u.label),1))]),_:1},8,["options","modelValue"])]),l(O,{modelValue:d(n).value.value,"onUpdate:modelValue":e[3]||(e[3]=u=>d(n).value.value=u),disable:d(h),error:!!d(n).errorMessage.value,"error-message":d(n).errorMessage.value,label:"內容",type:"textarea",outlined:""},null,8,["modelValue","disable","error","error-message"]),t.value.length>0?(p(),$("div",Le,[(p(!0),$(G,null,ee(t.value,(u,S)=>(p(),$("div",{key:S,class:"image-container",style:{position:"relative",width:"20%"}},[l(me,{src:u,style:{width:"100%"},alt:u},null,8,["src","alt"]),l(k,{round:"",dense:"",icon:"close",color:"negative",class:"delete-btn",size:"8px",onClick:Xe=>ve(S)},null,8,["onClick"])]))),128))])):E("",!0),l(B,{ref_key:"fileAgent",ref:y,modelValue:s.value,"onUpdate:modelValue":e[4]||(e[4]=u=>s.value=u),"raw-model-value":m.value,"onUpdate:rawModelValue":e[5]||(e[5]=u=>m.value=u),accept:"image/jpeg,image/png",deletable:"",disable:d(h),"error-text":{type:"檔案格式不正確",size:"檔案大小不得超過 5MB"},"help-text":"選擇或拖拽檔案",multiple:!0,maxFiles:5,"max-size":"5MB"},null,8,["modelValue","raw-model-value","disable"]),l(re,{label:d(o).value.value?"張貼中":"未張貼",modelValue:d(o).value.value,"onUpdate:modelValue":e[6]||(e[6]=u=>d(o).value.value=u),disable:d(h),error:!!d(o).errorMessage.value,"error-message":d(o).errorMessage.value},null,8,["label","modelValue","disable","error","error-message"]),l(ie,{align:"right"},{default:a(()=>[l(k,{color:"secondary",onClick:e[7]||(e[7]=u=>le(!1))},{default:a(()=>e[11]||(e[11]=[T("取消",-1)])),_:1,__:[11]}),l(k,{type:"submit",loading:d(h),color:"primary"},{default:a(()=>[T(A(c.work?"更新":"新增"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1}),l(Fe,{modelValue:L.value,"onUpdate:modelValue":e[8]||(e[8]=u=>L.value=u),tags:H.value,onClose:fe},null,8,["modelValue","tags"])]),_:1},8,["modelValue"])}}},Re=Ue(Pe,[["__scopeId","data-v-60beed41"]]),Ke={style:{"overflow-x":"auto","max-width":"100%"}},Je={style:{display:"flex","align-items":"center",gap:"8px"}},Ge={key:0,class:"row q-gutter-xs",style:{width:"150px"}},He={style:{width:"200px",height:"100px","overflow-y":"auto","white-space":"pre-line"}},yl={__name:"WorksPage",setup(w){const M=v([]),f=v(""),c=v(null),q=v([]);(async()=>{try{const{data:s}=await Ce.getAll();q.value=s.series.map(m=>({label:m.name,value:m._id})),console.log("獲取作品系列列表",q.value)}catch(s){console.error("獲取作品系列列表失敗",s)}})();const y=ke(()=>M.value.filter(s=>{const m=!f.value||s.name.toLowerCase().includes(f.value.toLowerCase()),t=!c.value||s.category._id===c.value;return m&&t})),g=v({page:1,rowsPerPage:5});J([f,c],()=>{g.value.page=1});const D=W(),h=[{name:"action",label:"操作",field:"action"},{name:"post",label:"發佈",field:"post"},{name:"name",label:"名稱",field:"name",align:"left",sortable:!0},{name:"images",label:"圖片",field:"images",align:"center",sortable:!1},{name:"category",label:"分類",field:s=>s.category.name},{name:"tags",label:"標籤",field:s=>s.tags.join(", "),align:"left"},{name:"content",label:"內容",field:"content"},{name:"statistics",label:"統計",field:"statistics"},{name:"createdAt",label:"建立日期",field:s=>new Date(s.createdAt).toLocaleString(),sortable:!0},{name:"updatedAt",label:"更新日期",field:s=>new Date(s.updatedAt).toLocaleString(),sortable:!0}],_=async()=>{try{console.log("獲取作品列表");const{data:s}=await Z.getAll();M.value=s.works}catch(s){console.error("Error fetching works:",s),D.notify({type:"negative",message:"無法載入作品資料"})}};_();const Q=s=>{D.dialog({title:"所有圖片",message:s.map(m=>`<img src="${m}" style="width: 100%; margin-bottom: 8px;" />`).join(""),html:!0})},n=v(!1),o=v(null),i=s=>{o.value=s,n.value=!0},U=()=>{_(),n.value=!1,o.value=null};return(s,m)=>(p(),C(Qe,{class:"flex flex-center"},{default:a(()=>[b("div",Ke,[l(_e,{separator:"cell",rows:y.value,columns:h,"row-key":"id",class:"q-table--dense",pagination:g.value,"onUpdate:pagination":m[3]||(m[3]=t=>g.value=t)},{top:a(()=>[l(he,null,{default:a(()=>[l(k,{flat:"",icon:"add",label:"新增作品",onClick:m[0]||(m[0]=t=>i(null)),class:"q-mr-sm"}),l(xe),l(O,{modelValue:f.value,"onUpdate:modelValue":m[1]||(m[1]=t=>f.value=t),dense:"",outlined:"",clearable:"",placeholder:"搜尋名稱"},{prepend:a(()=>[l(R,{name:"search"})]),_:1},8,["modelValue"]),l(de,{modelValue:c.value,"onUpdate:modelValue":m[2]||(m[2]=t=>c.value=t),dense:"",outlined:"",clearable:"",placeholder:"搜尋分類",options:q.value,"emit-value":"","map-options":""},{prepend:a(()=>[l(R,{name:"filter_list"})]),_:1},8,["modelValue","options"])]),_:1})]),"body-cell-images":a(t=>[l(N,{props:t},{default:a(()=>[b("div",Je,[t.row.images&&t.row.images.length>0?(p(),C(me,{key:0,src:t.row.images[0],style:{width:"100px",height:"100px"},class:"q-ma-sm",alt:t.row.name},null,8,["src","alt"])):E("",!0),t.row.images.length>1?(p(),C(k,{key:1,outline:"",dense:"",label:"更多",onClick:x=>Q(t.row.images)},null,8,["onClick"])):E("",!0)])]),_:2},1032,["props"])]),"body-cell-tags":a(t=>[l(N,{props:t},{default:a(()=>[t.row.tags.length>0?(p(),$("div",Ge,[(p(!0),$(G,null,ee(t.row.tags,x=>(p(),$(G,{key:x._id},[x.enable?(p(),C(te,{key:0,color:"primary",class:"q-mr-xs"},{default:a(()=>[T(A(x.name),1)]),_:2},1024)):(p(),C(te,{key:1,color:"grey",style:{"text-decoration":"line-through"},class:"q-mr-xs",outline:""},{default:a(()=>[T(A(x.name),1)]),_:2},1024))],64))),128))])):E("",!0)]),_:2},1032,["props"])]),"body-cell-content":a(t=>[l(N,{props:t},{default:a(()=>[b("div",He,A(t.row.content),1)]),_:2},1032,["props"])]),"body-cell-post":a(t=>[l(N,{props:t},{default:a(()=>[t.row.post?(p(),C(R,{key:0,name:"check",size:"md",color:"green"})):E("",!0)]),_:2},1032,["props"])]),"body-cell-statistics":a(t=>[l(N,{props:t},{default:a(()=>[b("div",null,[b("div",null,"瀏覽次數: "+A(t.row.statistics.views),1),b("div",null,"喜歡人數: "+A(t.row.statistics.likes.length),1)])]),_:2},1032,["props"])]),"body-cell-action":a(t=>[l(N,{props:t},{default:a(()=>[l(k,{flat:"",icon:"edit",onClick:x=>i(t.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","pagination"])]),l(Re,{modelValue:n.value,"onUpdate:modelValue":m[4]||(m[4]=t=>n.value=t),work:o.value,"series-options":q.value,onClose:U},null,8,["modelValue","work","series-options"])]),_:1}))}};export{yl as default};
